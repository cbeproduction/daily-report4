<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Daily Production and Dispatch Report</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f6f8; }
h1, h2 { text-align: center; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; background-color: white; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
th { background-color: #2a9df4; color: white; }
input { width: 90px; text-align: right; padding: 3px; }
button { padding: 10px 15px; margin: 10px 5px; font-size: 16px; cursor: pointer; }
a { color: #2a9df4; text-decoration: none; font-weight: bold; }
a:hover { text-decoration: underline; }
</style>
</head>
<body>

<h1>Daily Production and Dispatch Report</h1>

<div style="text-align:center; margin-bottom: 20px;">
  <label for="reportDate"><strong>Report Date:</strong></label>
  <input type="date" id="reportDate">
</div>

<!-- Accumulated Status -->
<h2>Accumulated Status</h2>
<table id="accumulatedStatus">
  <thead>
    <tr><th>SO NO</th><th>Description</th><th colspan="2">SPRING</th><th colspan="2">COIR</th><th>Total</th></tr>
    <tr><th></th><th></th><th>A</th><th>B</th><th>A</th><th>B</th><th></th></tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>TOTAL PRODUCTION</td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number" readonly></td></tr>
    <tr><td>2</td><td>PRODUCTION</td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number" readonly></td></tr>
    <tr><td>3</td><td>TAPE EDGE PRODUCTION</td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number" readonly></td></tr>
  </tbody>
</table>

<!-- Machine Output -->
<h2>Machine Output Status</h2>
<table id="machineOutputStatus">
  <thead>
    <tr><th>SO NO</th><th>Description</th><th colspan="2">SPRING</th><th colspan="2">COIR</th><th>Total</th></tr>
    <tr><th></th><th></th><th>A</th><th>B</th><th>A</th><th>B</th><th></th></tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>QUILTING M/C1</td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number" readonly></td></tr>
    <tr><td>2</td><td>BONNEL COILING</td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number" readonly></td></tr>
  </tbody>
</table>

<div style="text-align:center; margin-bottom: 20px;">
  <button onclick="submitPartialReport()">Submit (Before Shipment)</button>
</div>

<!-- Shipment -->
<h2>Shipment Status</h2>
<table id="shipmentStatus">
  <thead>
    <tr><th>SO NO</th><th>Description</th><th colspan="2">SPRING</th><th colspan="2">COIR</th><th>Total</th></tr>
    <tr><th></th><th></th><th>A</th><th>B</th><th>A</th><th>B</th><th></th></tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>DESPATCH</td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number" readonly></td></tr>
    <tr><td>2</td><td>DESPATCH PENDING</td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number"></td><td><input type="number" readonly></td></tr>
  </tbody>
</table>

<div style="text-align:center;">
  <button onclick="submitReport()">Submit</button>
  <button onclick="listReports()">View Reports</button>
  <button onclick="downloadCSV()">Download CSV</button>
</div>

<script>
function setupTable(tableId){
  const table = document.getElementById(tableId);
  table.querySelectorAll('tbody tr').forEach(row=>{
    const editable = Array.from(row.querySelectorAll('input:not([readonly])'));
    const total = row.querySelector('input[readonly]');
    const recalc = ()=> total.value = editable.reduce((sum,i)=>sum+(Number(i.value)||0),0);
    editable.forEach(inp=>{
      inp.addEventListener('input', recalc);
      inp.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          e.preventDefault();
          const allInputs = Array.from(document.querySelectorAll('input:not([readonly])'));
          const idx = allInputs.indexOf(inp);
          const next = allInputs[idx+1] || allInputs[0];
          next.focus(); next.select?.();
        }
      });
    });
    recalc();
  });
}
['accumulatedStatus','machineOutputStatus','shipmentStatus'].forEach(setupTable);

function collectData(){
  const data = { date: document.getElementById('reportDate').value };
  ['accumulatedStatus','machineOutputStatus','shipmentStatus'].forEach(id=>{
    const table = document.getElementById(id);
    data[id] = Array.from(table.querySelectorAll('tbody tr')).map(r=>{
      const tds = Array.from(r.querySelectorAll('td'));
      return [
        tds[0].innerText,
        tds[1].innerText,
        ...tds.slice(2).map(td=>{
          const inp = td.querySelector('input'); return inp?inp.value:td.innerText;
        })
      ];
    });
  });
  return data;
}

function submitPartialReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) { alert("Please select a date!"); return; }

    // Collect only Accumulated + Machine Output
    const data = { date: date };
    ['accumulatedStatus','machineOutputStatus'].forEach(id => {
        const table = document.getElementById(id);
        data[id] = Array.from(table.querySelectorAll('tbody tr')).map(r => {
            const tds = Array.from(r.querySelectorAll('td'));
            return [
                tds[0].innerText,
                tds[1].innerText,
                ...tds.slice(2).map(td => {
                    const inp = td.querySelector('input');
                    return inp ? inp.value : td.innerText;
                })
            ];
        });
    });

    // Get existing report and merge
    const allReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
    if (allReports[date]) {
        // Keep shipment if already present
        if (allReports[date].shipmentStatus) {
            data['shipmentStatus'] = allReports[date].shipmentStatus;
        }
    }

    allReports[date] = data;
    localStorage.setItem('dailyReports', JSON.stringify(allReports));
    alert("Partial report saved for " + date);
}


function submitReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) { alert("Please select a date!"); return; }

    const shipmentTable = document.getElementById('shipmentStatus');
    const shipmentData = Array.from(shipmentTable.querySelectorAll('tbody tr')).map(r => {
        const tds = Array.from(r.querySelectorAll('td'));
        return [
            tds[0].innerText,
            tds[1].innerText,
            ...tds.slice(2).map(td => {
                const inp = td.querySelector('input');
                return inp ? inp.value : td.innerText;
            })
        ];
    });

    const allReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
    const data = allReports[date] || { date: date };

    data['shipmentStatus'] = shipmentData;

    allReports[date] = data;
    localStorage.setItem('dailyReports', JSON.stringify(allReports));
    alert("Report saved with Shipment Status for " + date);
}


// âœ… Show list of all saved reports
function listReports() {
    const allReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
    if (Object.keys(allReports).length === 0) {
        alert("No reports saved!");
        return;
    }

    // Open a new window to list reports
    const listWin = window.open("", "_blank");
    let html = "<h2>Saved Reports</h2><ul>";

    for (const date in allReports) {
        html += `<li><a href="#" onclick="window.openReport('${date}')">${date}</a></li>`;
    }

    html += "</ul>";
    html += `<script>
        const reports = ${JSON.stringify(allReports)};
        function openReport(date){
            const data = reports[date];
            if(!data){ alert("No report for "+date); return; }

            let html = "<h1>Daily Production and Dispatch Report</h1>";
            const [y,m,d] = date.split("-");
            html += \`<h3 style='text-align:center;'>Date: \${d}/\${m}/\${y}</h3>\`;

            const renderTable = (title, rows) => {
                let t = "<h2>"+title+"</h2><table border='1' style='width:100%;border-collapse:collapse;'>";
                t += "<tr><th>SO</th><th>Description</th><th>Spring A</th><th>Spring B</th><th>Coir A</th><th>Coir B</th><th>Total</th></tr>";
                rows.forEach(r => t += "<tr>" + r.map(c => "<td>" + c + "</td>").join("") + "</tr>");
                return t + "</table>";
            };

            html += renderTable("Accumulated Status", data.accumulatedStatus);
            html += renderTable("Machine Output Status", data.machineOutputStatus);
            html += renderTable("Shipment Status", data.shipmentStatus);
            html += "<br><div style='text-align:center;'><button onclick='window.print()'>Print</button></div>";

            const reportWin = window.open("", "_blank");
            reportWin.document.write(html);
            reportWin.document.close();
        }
    <\/script>`;
    
    listWin.document.write(html);
    listWin.document.close();
}

function downloadCSV(){
  const date = document.getElementById('reportDate').value;
  if(!date){ alert("Select date to download"); return; }
  const allReports = JSON.parse(localStorage.getItem('dailyReports')||'{}');
  const data = allReports[date];
  if(!data){ alert("No report found for "+date); return; }
  let csv="Section,SO,Description,Spring A,Spring B,Coir A,Coir B,Total\n";
  for(const section of ['accumulatedStatus','machineOutputStatus','shipmentStatus']){
    data[section].forEach(r=>{
      csv += section+','+r.join(',')+'\n';
    });
  }
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `report_${date}.csv`;
  a.click();
}
</script>
</body>
</html>
